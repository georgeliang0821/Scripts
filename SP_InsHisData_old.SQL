USE [DWMD]
GO
/****** Object:  StoredProcedure [odsdba].[SP_InsHisData]    Script Date: 12/09/2008 15:42:05 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [odsdba].[SP_InsHisData]
    @DBNAME     CHAR(20),
    @TABLENAME  CHAR(30),
    @CYCLE_START DATETIME,
    @CYCLE_END DATETIME,    
    @INS_CNT INT = 0 OUTPUT --INSRT COUNT
AS
 
------------------------------
-- STEP1:以TABLE NAME找出TALBE SCHEMA
------------------------------      	
DECLARE @FIND_SCHEMA_SQL NVARCHAR(4000)
DECLARE @SCHEMA CHAR(20) --TABLE SCHEMA
DECLARE @ERROR_MESSAGE  NVARCHAR(4000) --錯誤訊息

SET @FIND_SCHEMA_SQL
   ='SELECT  @SCHEMA = S.NAME
     FROM  '+RTRIM(@DBNAME)+'.SYS.TABLES T
      JOIN '+RTRIM(@DBNAME)+'.SYS.SCHEMAS S ON S.SCHEMA_ID=T.SCHEMA_ID
    WHERE T.name = '''+RTRIM(@TABLENAME)+''''
    
BEGIN TRY
  EXECUTE sp_executesql @FIND_SCHEMA_SQL,N'@SCHEMA CHAR(20) OUT',@SCHEMA OUT;
  SET @SCHEMA = ISNULL(@SCHEMA,'')
END TRY
BEGIN CATCH      
  SET @ERROR_MESSAGE=ERROR_MESSAGE() 
  RAISERROR(@ERROR_MESSAGE,16,1);
END CATCH       
    
------------------------------
-- STEP2:找出目的資料庫
------------------------------      	
DECLARE @TAR_DBNAME CHAR(25)
SET @TAR_DBNAME = RTRIM(@DBNAME)+'_'+CONVERT(CHAR(4),YEAR(@CYCLE_END))

------------------------------
-- STEP3:IF EXISTS DELETE DATADT
------------------------------  

 DECLARE @DEL_EXIST_SQL NVARCHAR(MAX)
 SET @DEL_EXIST_SQL = 'IF EXISTS (SELECT TOP 1 * FROM ['+RTRIM(@TAR_DBNAME)+'].['+RTRIM(@SCHEMA)+'].['+RTRIM(@TABLENAME)+'] WHERE DATADT BETWEEN '''+CONVERT(CHAR(8),@CYCLE_START,112)+''' AND '''+CONVERT(CHAR(8),@CYCLE_END,112)+''') EXEC [DWMD].[odsdba].[SP_DelData] '''+RTRIM(@TAR_DBNAME)+''','''+RTRIM(@TABLENAME)+''','''+RTRIM(@TAR_DBNAME)+''','''+CONVERT(CHAR(8),@CYCLE_START,112)+''' ,'''+CONVERT(CHAR(8),@CYCLE_END,112)+''';' 
 
 --PRINT @DEL_EXIST_SQL

    BEGIN TRY
      EXEC SP_EXECUTESQL @DEL_EXIST_SQL
    END TRY
    BEGIN CATCH
        SET @ERROR_MESSAGE=ERROR_MESSAGE()
        RAISERROR(@ERROR_MESSAGE,16,1);
    END CATCH        
   
------------------------------
-- STEP4:INSERT DATADT
------------------------------  

 DECLARE @INS_DATA_SQL NVARCHAR(MAX)
 SET @INS_DATA_SQL = 'INSERT INTO ['+RTRIM(@TAR_DBNAME)+'].['+RTRIM(@SCHEMA)+'].['+RTRIM(@TABLENAME)+'] SELECT * FROM ['+RTRIM(@DBNAME)+'].['+RTRIM(@SCHEMA)+'].['+RTRIM(@TABLENAME)+'] WHERE DATADT BETWEEN '''+CONVERT(CHAR(8),@CYCLE_START,112)+''' AND '''+CONVERT(CHAR(8),@CYCLE_END,112)+''';SELECT @INS_CNT = @@ROWCOUNT;'
 
 --PRINT @INS_DATA_SQL
  
    BEGIN TRY
      EXEC SP_EXECUTESQL @INS_DATA_SQL,N'@INS_CNT INT OUT',@INS_CNT OUT
    END TRY
    BEGIN CATCH
        SET @ERROR_MESSAGE=ERROR_MESSAGE()
        RAISERROR(@ERROR_MESSAGE,16,1);
    END CATCH    
       
   
