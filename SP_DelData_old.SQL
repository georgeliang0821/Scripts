USE [DWMD]
GO
ALTER PROCEDURE [odsdba].[SP_DelData]
    @DBNAME     CHAR(20),
    @TABLENAME  CHAR(30),
    @CYCLE_START DATETIME,
    @CYCLE_END DATETIME,
    @DEL_CNT INT = 0 OUTPUT --DELETE COUNT
AS
 
------------------------------
-- STEP1:以TABLE NAME找出TALBE SCHEMA
------------------------------      	
DECLARE @FIND_SCHEMA_SQL NVARCHAR(4000)
DECLARE @SCHEMA CHAR(20) --TABLE SCHEMA
DECLARE @ERROR_MESSAGE  NVARCHAR(4000) --錯誤訊息

SET @FIND_SCHEMA_SQL
   ='SELECT  @SCHEMA = S.NAME 
     FROM  '+RTRIM(@DBNAME)+'.SYS.TABLES T
      JOIN '+RTRIM(@DBNAME)+'.SYS.SCHEMAS S ON S.SCHEMA_ID=T.SCHEMA_ID
    WHERE T.name = '''+RTRIM(@TABLENAME)+''''

BEGIN TRY
  EXECUTE sp_executesql @FIND_SCHEMA_SQL,N'@SCHEMA CHAR(20) OUT',@SCHEMA OUT;
END TRY
BEGIN CATCH      
  SET @ERROR_MESSAGE=ERROR_MESSAGE() 
  RAISERROR(@ERROR_MESSAGE,16,1);
END CATCH   

IF @SCHEMA IS NULL GOTO Main_Exit -- 找不到SCHEMA代表該物件不存在

------------------------------
-- STEP2:DELETE DATADT
------------------------------  

 DECLARE @DEL_DATA_SQL NVARCHAR(MAX)
 SET @DEL_DATA_SQL = 'DELETE FROM ['+RTRIM(@DBNAME)+'].['+RTRIM(@SCHEMA)+'].['+RTRIM(@TABLENAME)+'] WHERE DATADT BETWEEN '''+CONVERT(CHAR(8),@CYCLE_START,112)+''' AND '''+CONVERT(CHAR(8),@CYCLE_END,112)+''';SELECT @DEL_CNT = @@ROWCOUNT;'
 
-- PRINT @DEL_DATA_SQL
   
    BEGIN TRY
      EXEC SP_EXECUTESQL @DEL_DATA_SQL,N'@DEL_CNT INT OUT',@DEL_CNT OUT
    END TRY
    BEGIN CATCH
        SET @ERROR_MESSAGE=ERROR_MESSAGE()
        RAISERROR(@ERROR_MESSAGE,16,1);
    END CATCH          

------------------------------
-- 結束程式
   Main_Exit:
------------------------------